version: '3.8'

services:
  # ============================================
  # ZEBRA - Full Node (Regtest)
  # ============================================
  zebra:
    image: zfnd/zebra:1.10.0
    container_name: zeckit-zebra
    ports:
      - "127.0.0.1:8232:8232"  # RPC port
    volumes:
      - ./docker/configs/zebra.toml:/etc/zebrad/zebrad.toml:ro
      - zebra-data:/var/zebra
    environment:
      - ZEBRA_CONF_PATH=/etc/zebrad/zebrad.toml
    command: ["start"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8232"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - zeckit-network

  # ============================================
  # LIGHTWALLETD - Backend
  # ============================================
  lightwalletd:
    image: electriccoinco/lightwalletd:latest
    container_name: zeckit-lightwalletd
    ports:
      - "127.0.0.1:9067:9067"
    depends_on:
      zebra:
        condition: service_healthy
    command: [
      "--grpc-bind-addr=0.0.0.0:9067",
      "--zcash-conf-path=/etc/lightwalletd/zcash.conf",
      "--log-file=/dev/stdout",
      "--log-level=7",
      "--no-tls-very-insecure=true"
    ]
    volumes:
      - lightwalletd-data:/var/lib/lightwalletd
      - ./docker/configs/zcash.conf:/etc/lightwalletd/zcash.conf:ro
    networks:
      - zeckit-network
    profiles:
      - lwd

  # ============================================
  # ZINGO WALLET - REAL Wallet (ZingoLib)
  # ============================================
  zingo-wallet:
    build:
      context: ./docker/zingo
      dockerfile: Dockerfile
    container_name: zeckit-zingo-wallet
    volumes:
      - zingo-data:/var/zingo
    depends_on:
      zebra:
        condition: service_healthy
      lightwalletd:
        condition: service_started
    environment:
      - ZINGO_DATA_DIR=/var/zingo
      - LIGHTWALLETD_URI=http://lightwalletd:9067
    networks:
      - zeckit-network
    profiles:
      - lwd

  # ============================================
  # FAUCET - Python API calling Zingo-CLI
  # ============================================
  faucet:
    build:
      context: ./faucet
      dockerfile: Dockerfile
    container_name: zeckit-faucet
    ports:
      - "127.0.0.1:8080:8080"
    volumes:
      - ./faucet/app:/app
      - zingo-data:/var/zingo:ro
    depends_on:
      zebra:
        condition: service_healthy
      zingo-wallet:
        condition: service_started
    environment:
      - LIGHTWALLETD_URI=http://lightwalletd:9067
      - ZINGO_WALLET_PATH=/var/zingo/zingo-wallet.dat
      - ZINGO_CLI_PATH=/usr/local/bin/zingo-cli
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - zeckit-network

networks:
  zeckit-network:
    driver: bridge

volumes:
  zebra-data:
  zingo-data:
  lightwalletd-data: